<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시글 목록 - Unibook</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .post-card {
            transition: transform 0.2s, box-shadow 0.2s;
            height: 100%;
        }
        
        .post-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .post-image {
            height: 200px;
            object-fit: cover;
            background-color: #f8f9fa;
        }
        
        .no-image {
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            color: #6c757d;
        }
        
        .price {
            font-size: 1.25rem;
            font-weight: bold;
            color: #0d6efd;
        }
        
        .status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1;
        }
        
        .filter-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .school-filter {
            background-color: #e7f1ff;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        
        .pagination {
            justify-content: center;
        }
        
        .card-text {
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .author-info {
            font-size: 0.875rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
<!-- 공통 헤더 포함 -->
<nav th:replace="~{fragments/header :: header}"></nav>

<!-- 공통 메시지 포함 -->
<div th:replace="~{fragments/header :: messages}"></div>

<div class="container mt-4">
    
    <h2 class="mb-4">게시글 목록</h2>
    
    <!-- 우리 학교 필터 -->
    <div th:if="${userSchoolId != null}" class="school-filter">
        <form method="get" action="/posts" class="d-flex align-items-center">
            <input type="hidden" name="search" th:value="${search}">
            <input type="hidden" name="productType" th:value="${productType}">
            <input type="hidden" name="status" th:value="${status}">
            
            <div class="form-check mb-0">
                <input class="form-check-input" type="checkbox" id="schoolFilter" 
                       name="schoolId" th:value="${userSchoolId}" 
                       th:checked="${schoolId == userSchoolId}">
                <label class="form-check-label" for="schoolFilter">
                    <i class="bi bi-building"></i> 우리 학교 게시글만 보기
                </label>
            </div>
            <button type="submit" class="btn btn-sm btn-primary ms-3">적용</button>
        </form>
    </div>
    
    <!-- 필터 섹션 -->
    <div class="filter-section">
        <form method="get" action="/posts" class="row g-3">
            <div class="col-md-4">
                <label for="search" class="form-label">검색</label>
                <input type="text" class="form-control" id="search" name="search" 
                       th:value="${search}" placeholder="제목, 내용 검색">
            </div>
            <div class="col-md-3">
                <label for="productType" class="form-label">상품 유형</label>
                <select class="form-select" id="productType" name="productType">
                    <option value="">전체</option>
                    <option th:each="type : ${productTypes}" 
                            th:value="${type}" 
                            th:selected="${type == productType}"
                            th:text="${type.name() == 'TEXTBOOK' ? '전공교재' : 
                                     type.name() == 'CERTBOOK' ? '자격증 교재' :
                                     type.name() == 'NOTE' ? '필기노트' :
                                     type.name() == 'PASTEXAM' ? '족보/기출' : '기타'}"></option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="status" class="form-label">거래 상태</label>
                <select class="form-select" id="status" name="status">
                    <option value="">전체</option>
                    <option value="AVAILABLE" th:selected="${status == 'AVAILABLE'}">판매중</option>
                    <option value="RESERVED" th:selected="${status == 'RESERVED'}">예약중</option>
                    <option value="COMPLETED" th:selected="${status == 'COMPLETED'}">거래완료</option>
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search"></i> 검색
                </button>
            </div>
        </form>
    </div>
    
    <!-- 게시글 목록 -->
    <div th:if="${posts.content.isEmpty()}" class="text-center py-5">
        <i class="bi bi-inbox fs-1 text-muted"></i>
        <p class="mt-3 text-muted">등록된 게시글이 없습니다.</p>
        <a href="/posts/new" class="btn btn-primary" sec:authorize="isAuthenticated()">
            첫 게시글 작성하기
        </a>
    </div>
    
    <div th:if="${!posts.content.isEmpty()}" class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-4">
        <div th:each="post : ${posts.content}" class="col">
            <div class="card post-card">
                <!-- 상태 배지 -->
                <span class="badge status-badge"
                      th:classappend="${post.status.toString() == 'AVAILABLE' ? 'bg-success' : 
                                      post.status.toString() == 'RESERVED' ? 'bg-warning text-dark' : 
                                      'bg-secondary'}"
                      th:text="${post.status.toString() == 'AVAILABLE' ? '판매중' : 
                               post.status.toString() == 'RESERVED' ? '예약중' : 
                               '거래완료'}"></span>
                
                <!-- 이미지 -->
                <a th:href="@{/posts/{id}(id=${post.postId})}" class="text-decoration-none">
                    <img th:if="${post.images != null and !post.images.isEmpty()}" 
                         th:src="@{${post.images[0].imagePath}}" 
                         class="card-img-top post-image" 
                         alt="상품 이미지">
                    <div th:if="${post.images == null or post.images.isEmpty()}" class="no-image">
                        <i class="bi bi-image fs-1"></i>
                    </div>
                </a>
                
                <div class="card-body">
                    <!-- 상품 유형 -->
                    <small class="text-muted">
                        <span th:text="${post.productType.name() == 'TEXTBOOK' ? '전공교재' : 
                                       post.productType.name() == 'CERTBOOK' ? '자격증 교재' :
                                       post.productType.name() == 'NOTE' ? '필기노트' :
                                       post.productType.name() == 'PASTEXAM' ? '족보/기출' : '기타'}"></span>
                    </small>
                    
                    <!-- 제목 -->
                    <h5 class="card-title mt-2">
                        <a th:href="@{/posts/{id}(id=${post.postId})}" 
                           class="text-decoration-none text-dark"
                           th:text="${post.title}">제목</a>
                    </h5>
                    
                    <!-- 가격 -->
                    <p class="price mb-2" th:text="${#numbers.formatInteger(post.price, 0, 'COMMA') + '원'}">0원</p>
                    
                    <!-- 작성자 정보 -->
                    <div class="author-info">
                        <i class="bi bi-person"></i> 
                        <span th:text="${post.user.name}">작성자</span>
                        <span th:if="${post.user.departmentName != null}">
                            · <span th:text="${post.user.departmentName}">학과</span>
                        </span>
                    </div>
                    
                    <!-- 추가 정보 -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <small class="text-muted">
                            <i class="bi bi-eye"></i> <span th:text="${post.viewCount}">0</span>
                            <i class="bi bi-heart ms-2"></i> <span th:text="${post.wishlistCount}">0</span>
                        </small>
                        <small class="text-muted" 
                               th:text="${#temporals.format(post.createdAt, 'MM.dd')}">01.01</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 페이지네이션 -->
    <nav th:if="${posts.totalPages > 1}" class="mt-5">
        <ul class="pagination">
            <!-- 이전 페이지 -->
            <li class="page-item" th:classappend="${!posts.hasPrevious()} ? 'disabled'">
                <a class="page-link" 
                   th:href="@{/posts(page=${posts.number - 1}, search=${search}, 
                           productType=${productType}, status=${status}, schoolId=${schoolId})}"
                   tabindex="-1">이전</a>
            </li>
            
            <!-- 페이지 번호 -->
            <li th:each="pageNum : ${#numbers.sequence(0, posts.totalPages - 1)}" 
                class="page-item" 
                th:classappend="${pageNum == posts.number} ? 'active'"
                th:if="${pageNum >= posts.number - 2 and pageNum <= posts.number + 2}">
                <a class="page-link" 
                   th:href="@{/posts(page=${pageNum}, search=${search}, 
                           productType=${productType}, status=${status}, schoolId=${schoolId})}"
                   th:text="${pageNum + 1}">1</a>
            </li>
            
            <!-- 다음 페이지 -->
            <li class="page-item" th:classappend="${!posts.hasNext()} ? 'disabled'">
                <a class="page-link" 
                   th:href="@{/posts(page=${posts.number + 1}, search=${search}, 
                           productType=${productType}, status=${status}, schoolId=${schoolId})}">다음</a>
            </li>
        </ul>
    </nav>
</div>

<!-- 공통 Footer 포함 -->
<footer th:replace="~{fragments/header :: footer}"></footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // 학교 필터 자동 제출
    document.getElementById('schoolFilter')?.addEventListener('change', function() {
        this.form.submit();
    });
</script>
</body>
</html>