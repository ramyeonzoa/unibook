<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    
    <!-- ì‚¬ìš©ì ì •ë³´ ë©”íƒ€ íƒœê·¸ -->
    <div th:replace="~{fragments/header :: user-meta}"></div>
    
    <title>ê²Œì‹œê¸€ ëª©ë¡ - Unibook</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link th:href="@{/css/search-highlight.css}" rel="stylesheet">
    <!-- ê³µí†µ ìŠ¤íƒ€ì¼ (ì•Œë¦¼ ë“±) -->
    <div th:replace="~{fragments/header :: styles}"></div>
    <style>
        /* CSS ë³€ìˆ˜ ì •ì˜ */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            --card-hover-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
            --border-radius: 16px;
        }
        
        /* íˆì–´ë¡œ ì„¹ì…˜ */
        .hero-section {
            background: var(--primary-gradient);
            color: white;
            padding: 60px 0 120px;
            position: relative;
            overflow: hidden;
        }
        
        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23fff' fill-opacity='0.05'%3E%3Ccircle cx='50' cy='50' r='40'/%3E%3C/g%3E%3C/svg%3E");
            background-size: 200px 200px;
        }
        
        .hero-section h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        /* ê²€ìƒ‰/í•„í„° ì¹´ë“œ */
        .search-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin-top: -80px;
            position: relative;
            z-index: 10;
        }
        
        /* ë¹ ë¥¸ í•„í„° ë²„íŠ¼ */
        .quick-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 25px;
        }
        
        .filter-pill {
            padding: 8px 20px;
            border-radius: 25px;
            border: 1px solid #dee2e6;
            background: white;
            color: #495057;
            text-decoration: none;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .filter-pill:hover {
            border-color: #667eea;
            color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        
        .filter-pill.active {
            background: var(--primary-gradient);
            color: white;
            border-color: transparent;
        }
        
        /* ì •ë ¬ ì˜µì…˜ ìŠ¤íƒ€ì¼ ê°œì„  */
        .sort-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .sort-links {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        
        .sort-links a {
            padding: 6px 16px;
            border-radius: 20px;
            color: #6c757d;
            text-decoration: none;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }
        
        .sort-links a:hover {
            background: #e9ecef;
            color: #495057;
        }
        
        .sort-links a.active {
            background: var(--primary-gradient);
            color: white;
            font-weight: 500;
        }
        
        /* ê²Œì‹œê¸€ ì¹´ë“œ ê°œì„  */
        .post-card {
            background: white;
            border: none;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            height: 100%;
            cursor: pointer;
            will-change: transform, box-shadow;
        }
        
        .post-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--card-hover-shadow);
        }
        
        .post-image-container {
            position: relative;
            height: 220px;
            overflow: hidden;
            background: linear-gradient(135deg, #f5f5f5 0%, #e9ecef 100%);
        }
        
        .post-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .post-card:hover .post-image {
            transform: scale(1.05);
        }
        
        .no-image {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%);
        }
        
        .no-image i {
            font-size: 4rem;
            color: #667eea40;
        }
        
        /* ìƒíƒœ ë°°ì§€ ê°œì„  */
        /* ìƒíƒœ ë°°ì§€ - detail.htmlê³¼ í†µì¼ */
        .status-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            z-index: 2;
        }
        
        .status-badge.available {
            background: #d4edda;
            color: #155724;
        }
        
        .status-badge.reserved {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-badge.completed {
            background: #e2e3e5;
            color: #383d41;
        }
        
        /* ì¹´ë“œ ë°”ë”” ìŠ¤íƒ€ì¼ */
        .card-body {
            padding: 20px;
        }
        
        .product-type {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .product-type.textbook {
            background: #e7f3ff;
            color: #0066cc;
        }
        
        .product-type.certbook {
            background: #fff3cd;
            color: #856404;
        }
        
        .product-type.note {
            background: #d4edda;
            color: #155724;
        }
        
        .product-type.pastexam {
            background: #f8d7da;
            color: #721c24;
        }
        
        .product-type.other {
            background: #e2e3e5;
            color: #383d41;
        }
        
        .post-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #212529;
            margin-bottom: 8px;
            line-height: 1.4;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .post-title:hover {
            color: #667eea;
        }
        
        .price {
            font-size: 1.4rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 12px;
        }
        
        /* ë©”íƒ€ ì •ë³´ ìŠ¤íƒ€ì¼ */
        .meta-info {
            font-size: 0.85rem;
            color: #6c757d;
            line-height: 1.6;
        }
        
        .meta-info i {
            width: 16px;
        }
        
        /* í•˜ë‹¨ ì •ë³´ ìŠ¤íƒ€ì¼ */
        .card-footer-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
        }
        
        /* ì°œí•˜ê¸° í•˜íŠ¸ ìŠ¤íƒ€ì¼ */
        .wishlist-heart-icon {
            font-size: 1.2rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .wishlist-heart-icon:hover {
            transform: scale(1.3);
            color: #dc3545 !important;
        }
        
        .wishlist-heart-icon.bi-heart-fill {
            color: #dc3545 !important;
        }
        
        /* í˜ì´ì§€ë„¤ì´ì…˜ ê°œì„  */
        .pagination {
            justify-content: center;
            margin-top: 50px;
            gap: 5px;
        }
        
        .page-link {
            border: none;
            padding: 10px 16px;
            border-radius: 10px;
            color: #6c757d;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .page-link:hover {
            background: #f0f0f0;
            color: #495057;
        }
        
        .page-item.active .page-link {
            background: var(--primary-gradient);
            color: white;
        }
        
        .page-item.disabled .page-link {
            background: transparent;
            color: #dee2e6;
        }
        
        /* ë¹ˆ ìƒíƒœ ë””ìì¸ */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
        }
        
        .empty-state i {
            font-size: 5rem;
            color: #dee2e6;
            margin-bottom: 20px;
        }
        
        .empty-state h3 {
            color: #495057;
            margin-bottom: 10px;
        }
        
        .empty-state p {
            color: #6c757d;
            margin-bottom: 30px;
        }
        
        /* ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }
        
        .post-card {
            opacity: 0;
            animation: fadeInUp 0.6s ease-out forwards;
        }
        
        .col:nth-child(1) .post-card { animation-delay: 0.1s; }
        .col:nth-child(2) .post-card { animation-delay: 0.15s; }
        .col:nth-child(3) .post-card { animation-delay: 0.2s; }
        .col:nth-child(4) .post-card { animation-delay: 0.25s; }
        .col:nth-child(5) .post-card { animation-delay: 0.3s; }
        .col:nth-child(6) .post-card { animation-delay: 0.35s; }
        .col:nth-child(7) .post-card { animation-delay: 0.4s; }
        .col:nth-child(8) .post-card { animation-delay: 0.45s; }
        
        /* ë¡œë”© ìƒíƒœ ìŠ¤ì¼ˆë ˆí†¤ */
        .skeleton {
            position: relative;
            overflow: hidden;
            background: #f0f0f0;
        }
        
        .skeleton::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: skeleton-loading 1.5s infinite;
        }
        
        @keyframes skeleton-loading {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .skeleton-card {
            height: 400px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }
        
        /* ì´ë¯¸ì§€ ë ˆì´ì§€ ë¡œë”© */
        .post-image.lazy {
            filter: blur(5px);
            transition: filter 0.3s;
        }
        
        .post-image.loaded {
            filter: blur(0);
        }
        
        /* ë¶€ë“œëŸ¬ìš´ ì „í™˜ íš¨ê³¼ */
        .page-transition {
            transition: opacity 0.3s ease;
        }
        
        .page-transition.loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        /* ê²€ìƒ‰ ê²°ê³¼ ì •ë³´ */
        .search-info {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .search-info .search-term {
            font-weight: 600;
            color: #667eea;
        }
        
        /* ë¡œë”© ìŠ¤íƒ€ì¼ */
        .loading-spinner {
            display: flex;
            justify-content: center;
            padding: 60px;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
            border-width: 0.3em;
        }
        
        /* í•™êµ í•„í„° ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .school-filter-wrapper {
            background: white;
            padding: 12px 20px;
            border-radius: 25px;
            border: 1px solid #dee2e6;
            display: inline-block;
            transition: all 0.3s ease;
        }
        
        .school-filter-wrapper:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        
        .form-check-input:checked {
            background-color: #667eea;
            border-color: #667eea;
        }
        
        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            .hero-section h1 {
                font-size: 2rem;
            }
            
            .search-card {
                padding: 20px;
                margin-top: -60px;
            }
            
            .sort-section {
                flex-direction: column;
                align-items: stretch;
            }
            
            .quick-filters {
                justify-content: center;
            }
            
            .filter-pill {
                font-size: 0.85rem;
                padding: 6px 15px;
            }
            
            .post-image-container {
                height: 180px;
            }
        }
        
        /* ë‹¤í¬ëª¨ë“œ ìŠ¤íƒ€ì¼ */
        [data-bs-theme="dark"] .search-card {
            background: var(--bs-dark);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        
        [data-bs-theme="dark"] .filter-pill {
            background: var(--bs-gray-800);
            border-color: var(--bs-gray-700);
            color: var(--bs-gray-300);
        }
        
        [data-bs-theme="dark"] .filter-pill:hover {
            border-color: #667eea;
            color: #667eea;
            background: var(--bs-gray-700);
        }
        
        [data-bs-theme="dark"] .sort-section {
            background: var(--bs-gray-800);
        }
        
        [data-bs-theme="dark"] .sort-links a {
            color: var(--bs-gray-400);
        }
        
        [data-bs-theme="dark"] .sort-links a:hover {
            background: var(--bs-gray-700);
            color: var(--bs-gray-200);
        }
        
        [data-bs-theme="dark"] .post-card {
            background: var(--bs-dark);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        [data-bs-theme="dark"] .post-card:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        }
        
        [data-bs-theme="dark"] .post-title {
            color: var(--bs-gray-100);
        }
        
        [data-bs-theme="dark"] .post-title:hover {
            color: #8b9bff;
        }
        
        [data-bs-theme="dark"] .card-footer-info {
            border-top-color: var(--bs-gray-700);
        }
        
        [data-bs-theme="dark"] .search-info {
            background: var(--bs-gray-800);
            border-color: #8b9bff;
        }
        
        [data-bs-theme="dark"] .school-filter-wrapper {
            background: var(--bs-gray-800);
            border-color: var(--bs-gray-700);
        }
        
        [data-bs-theme="dark"] .page-link {
            background: transparent;
            color: var(--bs-gray-400);
        }
        
        [data-bs-theme="dark"] .page-link:hover {
            background: var(--bs-gray-700);
            color: var(--bs-gray-200);
        }
        
        [data-bs-theme="dark"] .empty-state i {
            color: var(--bs-gray-600);
        }
        
        [data-bs-theme="dark"] .empty-state h3 {
            color: var(--bs-gray-200);
        }
        
        [data-bs-theme="dark"] .meta-info {
            color: var(--bs-gray-400);
        }
        
        /* ìƒíƒœ ë°°ì§€ ë‹¤í¬ëª¨ë“œ */
        [data-bs-theme="dark"] .status-badge.available {
            background: rgba(25, 135, 84, 0.2);
            color: #70db8f;
        }
        
        [data-bs-theme="dark"] .status-badge.reserved {
            background: rgba(255, 193, 7, 0.2);
            color: #ffda6a;
        }
        
        [data-bs-theme="dark"] .status-badge.completed {
            background: rgba(108, 117, 125, 0.2);
            color: #adb5bd;
        }
    </style>
</head>
<body>
<!-- ê³µí†µ í—¤ë” í¬í•¨ -->
<nav th:replace="~{fragments/header :: header}"></nav>

<!-- ê³µí†µ ë©”ì‹œì§€ í¬í•¨ -->
<div th:replace="~{fragments/header :: messages}"></div>

<!-- íˆì–´ë¡œ ì„¹ì…˜ -->
<section class="hero-section">
    <div class="container position-relative">
        <h1 th:text="${pageTitle ?: 'ê²Œì‹œê¸€ ë‘˜ëŸ¬ë³´ê¸°'}">ê²Œì‹œê¸€ ë‘˜ëŸ¬ë³´ê¸°</h1>
        <p class="lead mb-0" th:switch="${pageType}">
            <span th:case="'my'">ë‚´ê°€ ë“±ë¡í•œ ëª¨ë“  ê²Œì‹œê¸€ì„ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”</span>
            <span th:case="'wishlist'">ê´€ì‹¬ìˆëŠ” ê²Œì‹œê¸€ì„ ëª¨ì•„ì„œ í™•ì¸í•˜ì„¸ìš”</span>
            <span th:case="*">ìš°ë¦¬ í•™êµ, ìš°ë¦¬ í•™ê³¼ ì„ ë°°ë“¤ì˜ ê±°ë˜ ê²Œì‹œê¸€ì„ ì°¾ì•„ë³´ì„¸ìš”</span>
        </p>
    </div>
</section>

<!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
<div class="container">
    <!-- ê²€ìƒ‰ ì¹´ë“œ -->
    <div class="search-card">
        <!-- ë¹ ë¥¸ í•„í„° (ì¼ë°˜ ê²Œì‹œê¸€ ëª©ë¡ì—ì„œë§Œ í‘œì‹œ) -->
        <div th:if="${pageType == null}" class="quick-filters">
            <span class="text-muted me-3"><i class="bi bi-funnel"></i> ë¹ ë¥¸ í•„í„°:</span>
            <a href="/posts?productType=TEXTBOOK" class="filter-pill" 
               th:classappend="${productType == 'TEXTBOOK' ? 'active' : ''}">
                <i class="bi bi-book"></i> ì „ê³µêµì¬
            </a>
            <a href="/posts?productType=CERTBOOK" class="filter-pill"
               th:classappend="${productType == 'CERTBOOK' ? 'active' : ''}">
                <i class="bi bi-award"></i> ìê²©ì¦ êµì¬
            </a>
            <a href="/posts?productType=NOTE" class="filter-pill"
               th:classappend="${productType == 'NOTE' ? 'active' : ''}">
                <i class="bi bi-journal-text"></i> í•„ê¸°ë…¸íŠ¸
            </a>
            <a href="/posts?productType=PASTEXAM" class="filter-pill"
               th:classappend="${productType == 'PASTEXAM' ? 'active' : ''}">
                <i class="bi bi-file-earmark-text"></i> ì¡±ë³´/ê¸°ì¶œ
            </a>
            <a href="/posts?status=AVAILABLE" class="filter-pill"
               th:classappend="${status == 'AVAILABLE' ? 'active' : ''}">
                <i class="bi bi-check-circle"></i> íŒë§¤ì¤‘ë§Œ ë³´ê¸°
            </a>
        </div>
        
        <!-- ìƒì„¸ ê²€ìƒ‰ í¼ -->
        <form method="get" th:action="${pageType == 'my' ? '/posts/my' : (pageType == 'wishlist' ? '/posts/wishlist' : '/posts')}" 
              class="row g-3" id="searchForm">
            <div class="col-md-6">
                <label for="search" class="form-label fw-medium">
                    <i class="bi bi-search"></i> í†µí•© ê²€ìƒ‰
                </label>
                <input type="text" class="form-control form-control-lg" id="search" name="search" 
                       th:value="${search}" placeholder="ì œëª©, ë‚´ìš©, ê³¼ëª©ëª…, êµìˆ˜ëª…ìœ¼ë¡œ ê²€ìƒ‰">
            </div>
            <div class="col-md-2">
                <label for="productType" class="form-label fw-medium">ìƒí’ˆ ìœ í˜•</label>
                <select class="form-select form-select-lg" id="productType" name="productType">
                    <option value="">ì „ì²´</option>
                    <option th:each="type : ${productTypes}" 
                            th:value="${type}" 
                            th:selected="${type == productType}"
                            th:text="${type.name() == 'TEXTBOOK' ? 'ì „ê³µêµì¬' : 
                                     type.name() == 'CERTBOOK' ? 'ìê²©ì¦ êµì¬' :
                                     type.name() == 'NOTE' ? 'í•„ê¸°ë…¸íŠ¸' :
                                     type.name() == 'PASTEXAM' ? 'ì¡±ë³´/ê¸°ì¶œ' : 'ê¸°íƒ€'}"></option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="status" class="form-label fw-medium">ê±°ë˜ ìƒíƒœ</label>
                <select class="form-select form-select-lg" id="status" name="status">
                    <option value="">ì „ì²´</option>
                    <option value="AVAILABLE" th:selected="${status == 'AVAILABLE'}">íŒë§¤ì¤‘</option>
                    <option value="RESERVED" th:selected="${status == 'RESERVED'}">ì˜ˆì•½ì¤‘</option>
                    <option value="COMPLETED" th:selected="${status == 'COMPLETED'}">ê±°ë˜ì™„ë£Œ</option>
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary btn-lg w-100" id="searchButton">
                    <i class="bi bi-search"></i> <span class="button-text">ê²€ìƒ‰</span>
                    <span class="spinner-border spinner-border-sm ms-2 d-none" role="status"></span>
                </button>
            </div>
            <!-- í•™êµ í•„í„° ìœ ì§€ë¥¼ ìœ„í•œ hidden input -->
            <input type="hidden" name="schoolId" th:value="${schoolId}">
        </form>
    </div>
    
    <!-- ì •ë ¬ ë° í•„í„° ì˜µì…˜ -->
    <div class="sort-section">
        <!-- í•™êµ í•„í„° -->
        <div th:if="${pageType == null and userSchoolId != null}" sec:authorize="isAuthenticated()">
            <form method="get" action="/posts" class="d-inline-block" 
                  th:if="${#authentication.principal.verified}">
                <input type="hidden" name="search" th:value="${search}">
                <input type="hidden" name="productType" th:value="${productType}">
                <input type="hidden" name="status" th:value="${status}">
                <input type="hidden" name="sortBy" th:value="${sortBy}">
                
                <div class="school-filter-wrapper">
                    <div class="form-check mb-0">
                        <input class="form-check-input" type="checkbox" id="schoolFilter" 
                               name="schoolId" th:value="${userSchoolId}" 
                               th:checked="${schoolId == userSchoolId}"
                               onchange="this.form.submit()">
                        <label class="form-check-label" for="schoolFilter">
                            <i class="bi bi-building-fill"></i> ìš°ë¦¬ í•™êµ ê²Œì‹œê¸€ë§Œ ë³´ê¸°
                        </label>
                    </div>
                </div>
            </form>
            <span class="text-muted" th:unless="${#authentication.principal.verified}">
                <i class="bi bi-info-circle"></i> ì´ë©”ì¼ ì¸ì¦ í›„ ìš°ë¦¬ í•™êµ í•„í„°ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
            </span>
        </div>
        
        <!-- ì •ë ¬ ì˜µì…˜ -->
        <div class="sort-links">
            <span class="text-muted me-2">ì •ë ¬:</span>
            <span th:with="baseUrl=${pageType == 'my' ? '/posts/my' : (pageType == 'wishlist' ? '/posts/wishlist' : '/posts')}">
                <a th:href="@{${baseUrl}(search=${search}, productType=${productType}, status=${status}, 
                                   schoolId=${schoolId}, sortBy='RELEVANCE')}"
                   th:classappend="${sortBy == 'RELEVANCE' ? 'active' : ''}"
                   th:style="${search == null or search.isEmpty() ? 'display: none;' : ''}">
                    <i class="bi bi-star"></i> ê´€ë ¨ë„ìˆœ
                </a>
                <a th:href="@{${baseUrl}(sortBy='NEWEST')}"
                   th:classappend="${sortBy == 'NEWEST' ? 'active' : ''}">
                    <i class="bi bi-clock"></i> ìµœì‹ ìˆœ
                </a>
                <a th:href="@{${baseUrl}(sortBy='PRICE_ASC')}"
                   th:classappend="${sortBy == 'PRICE_ASC' ? 'active' : ''}">
                    <i class="bi bi-arrow-down"></i> ê°€ê²© ë‚®ì€ìˆœ
                </a>
                <a th:href="@{${baseUrl}(sortBy='PRICE_DESC')}"
                   th:classappend="${sortBy == 'PRICE_DESC' ? 'active' : ''}">
                    <i class="bi bi-arrow-up"></i> ê°€ê²© ë†’ì€ìˆœ
                </a>
                <a th:href="@{${baseUrl}(sortBy='VIEW_COUNT')}"
                   th:classappend="${sortBy == 'VIEW_COUNT' ? 'active' : ''}">
                    <i class="bi bi-eye"></i> ì¡°íšŒìˆ˜ìˆœ
                </a>
            </span>
        </div>
    </div>
    
    <!-- ê²€ìƒ‰ ì •ë³´ í‘œì‹œ -->
    <div th:if="${search != null and !search.isEmpty()}" class="search-info">
        <i class="bi bi-search"></i> 
        "<span class="search-term" th:text="${search}"></span>" ê²€ìƒ‰ ê²°ê³¼ 
        <strong th:text="${posts.totalElements}">0</strong>ê°œ
    </div>
    
    <!-- ê²Œì‹œê¸€ ëª©ë¡ -->
    <div th:if="${posts.content.isEmpty()}" class="empty-state">
        <i class="bi bi-inbox"></i>
        <!-- pageTypeì— ë”°ë¥¸ ë©”ì‹œì§€ ë¶„ê¸° -->
        <div th:switch="${pageType}">
            <!-- ë‚´ ê²Œì‹œê¸€ -->
            <div th:case="'my'">
                <h3>ì•„ì§ ì‘ì„±í•œ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                <p>ì²« ë²ˆì§¸ ê±°ë˜ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!</p>
                <div sec:authorize="isAuthenticated()">
                    <a href="/posts/new" class="btn btn-primary btn-lg" th:if="${#authentication.principal.verified}">
                        <i class="bi bi-plus-circle me-2"></i>ì²« ê²Œì‹œê¸€ ì‘ì„±í•˜ê¸°
                    </a>
                    <div th:unless="${#authentication.principal.verified}">
                        <p class="text-muted">ê²Œì‹œê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ <a href="/verification-required">ì´ë©”ì¼ ì¸ì¦</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
            <!-- ì°œ ëª©ë¡ -->
            <div th:case="'wishlist'">
                <h3>ì•„ì§ ì°œí•œ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                <p>ê´€ì‹¬ìˆëŠ” ê²Œì‹œê¸€ì„ ì°œí•´ì„œ ë‚˜ì¤‘ì— ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”!</p>
                <div sec:authorize="isAuthenticated()">
                    <a href="/posts" class="btn btn-primary btn-lg">
                        <i class="bi bi-search me-2"></i>ê²Œì‹œê¸€ ë‘˜ëŸ¬ë³´ê¸°
                    </a>
                    <div th:unless="${#authentication.principal.verified}">
                        <p class="text-muted mt-3">ì°œí•˜ê¸° ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ <a href="/verification-required">ì´ë©”ì¼ ì¸ì¦</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
            <!-- ì¼ë°˜ ëª©ë¡ -->
            <div th:case="*">
                <h3>ë“±ë¡ëœ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                <p>ì²« ë²ˆì§¸ ê²Œì‹œê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
                <a href="/posts/new" class="btn btn-primary btn-lg" sec:authorize="isAuthenticated()">
                    <i class="bi bi-plus-circle me-2"></i>ì²« ê²Œì‹œê¸€ ì‘ì„±í•˜ê¸°
                </a>
            </div>
        </div>
    </div>
    
    <div th:if="${!posts.content.isEmpty()}" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4 mt-2">
        <div th:each="post : ${posts.content}" class="col">
            <div class="card post-card" th:onclick="|window.location.href='/posts/${post.postId}'|">
                <!-- ì´ë¯¸ì§€ ì˜ì—­ -->
                <div class="post-image-container">
                    <!-- ìƒíƒœ ë°°ì§€ -->
                    <span class="status-badge"
                          th:classappend="${post.status.toString() == 'AVAILABLE' ? 'available' : 
                                          (post.status.toString() == 'RESERVED' ? 'reserved' : 'completed')}">
                        <i th:class="${post.status.toString() == 'AVAILABLE' ? 'bi bi-check-circle' : 
                                     (post.status.toString() == 'RESERVED' ? 'bi bi-clock' : 'bi bi-check-square')}"></i>
                        <span th:text="${post.status.toString() == 'AVAILABLE' ? 'íŒë§¤ì¤‘' : 
                                       (post.status.toString() == 'RESERVED' ? 'ì˜ˆì•½ì¤‘' : 'ê±°ë˜ì™„ë£Œ')}"></span>
                    </span>
                    
                    <!-- ì´ë¯¸ì§€ -->
                    <img th:if="${post.images != null and !post.images.isEmpty()}" 
                         th:data-src="@{${post.images[0].imagePath}}"
                         src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3C/svg%3E"
                         class="post-image lazy" 
                         alt="ìƒí’ˆ ì´ë¯¸ì§€">
                    <div th:if="${post.images == null or post.images.isEmpty()}" class="no-image">
                        <i th:class="${post.productType.toString() == 'TEXTBOOK' ? 'bi bi-book' : 
                                     (post.productType.toString() == 'CERTBOOK' ? 'bi bi-award' : 
                                     (post.productType.toString() == 'NOTE' ? 'bi bi-journal-text' : 
                                     (post.productType.toString() == 'PASTEXAM' ? 'bi bi-file-earmark-text' : 'bi bi-box')))}"></i>
                    </div>
                </div>
                
                <div class="card-body">
                    <!-- ìƒí’ˆ ìœ í˜• -->
                    <span class="product-type"
                          th:classappend="${post.productType.toString() == 'TEXTBOOK' ? 'textbook' : 
                                          (post.productType.toString() == 'CERTBOOK' ? 'certbook' : 
                                          (post.productType.toString() == 'NOTE' ? 'note' : 
                                          (post.productType.toString() == 'PASTEXAM' ? 'pastexam' : 'other')))}"
                          th:text="${post.productType.name() == 'TEXTBOOK' ? 'ì „ê³µêµì¬' : 
                                   post.productType.name() == 'CERTBOOK' ? 'ìê²©ì¦ êµì¬' :
                                   post.productType.name() == 'NOTE' ? 'í•„ê¸°ë…¸íŠ¸' :
                                   post.productType.name() == 'PASTEXAM' ? 'ì¡±ë³´/ê¸°ì¶œ' : 'ê¸°íƒ€'}"></span>
                    
                    <!-- ì œëª© -->
                    <h5 class="post-title" th:text="${post.title}">ì œëª©</h5>
                    
                    <!-- ê°€ê²© -->
                    <p class="price mb-3" th:text="${#numbers.formatInteger(post.price, 0, 'COMMA') + 'ì›'}">0ì›</p>
                    
                    <!-- ë©”íƒ€ ì •ë³´ -->
                    <div class="meta-info">
                        <!-- ê³¼ëª©/êµìˆ˜ ì •ë³´ -->
                        <div th:if="${post.subjectName != null}" class="mb-1">
                            <i class="bi bi-book-fill"></i>
                            <span class="post-subject-name" th:text="${post.subjectName}">ê³¼ëª©ëª…</span>
                            <span th:if="${post.professorName != null}">
                                Â· <span class="post-professor-name" th:text="${post.professorName}">êµìˆ˜ëª…</span>
                            </span>
                        </div>
                        
                        <!-- ì±… ì •ë³´ -->
                        <div th:if="${post.bookTitle != null}" class="mb-1">
                            <i class="bi bi-journal-bookmark-fill"></i>
                            <span class="post-book-title" th:text="${post.bookTitle}">ì±… ì œëª©</span>
                        </div>
                        
                        <!-- ì‘ì„±ì ì •ë³´ -->
                        <div class="mb-1">
                            <i class="bi bi-person-fill"></i>
                            <span th:text="${post.user.name}">ì‘ì„±ì</span>
                            <span th:if="${post.user.departmentName != null}">
                                Â· <span th:text="${post.user.departmentName}">í•™ê³¼</span>
                            </span>
                        </div>
                    </div>
                    
                    <!-- í•˜ë‹¨ ì •ë³´ -->
                    <div class="card-footer-info">
                        <small class="text-muted">
                            <i class="bi bi-eye-fill"></i> <span th:text="${post.viewCount}">0</span>
                            
                            <!-- ì°œí•˜ê¸° í•˜íŠ¸ ì•„ì´ì½˜ -->
                            <span class="ms-2">
                                <!-- ë¡œê·¸ì¸í•œ ì‚¬ìš©ì -->
                                <span sec:authorize="isAuthenticated()">
                                    <!-- íƒ€ì¸ì˜ ê²Œì‹œê¸€ -->
                                    <i th:if="${post.user.userId != #authentication.principal.userId}"
                                       class="bi bi-heart wishlist-heart-icon" 
                                       th:data-post-id="${post.postId}"
                                       onclick="event.stopPropagation();"
                                       title="ì°œí•˜ê¸°"></i>
                                    <!-- ìì‹ ì˜ ê²Œì‹œê¸€ -->
                                    <i th:if="${post.user.userId == #authentication.principal.userId}"
                                       class="bi bi-heart my-post-heart-icon" 
                                       style="color: #adb5bd; cursor: not-allowed;"
                                       onclick="event.stopPropagation();"
                                       title="ë‚´ ê²Œì‹œê¸€"></i>
                                </span>
                                <!-- ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ì -->
                                <i sec:authorize="!isAuthenticated()" class="bi bi-heart text-muted"></i>
                                
                                <span th:text="${post.wishlistCount}" class="wishlist-count">0</span>
                            </span>
                        </small>
                        <small class="text-muted" 
                               th:text="${#temporals.format(post.createdAt, 'MM.dd HH:mm')}">01.01</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
    <nav th:if="${posts.totalPages > 1}" class="mt-5">
        <ul class="pagination">
            <!-- ì²˜ìŒ í˜ì´ì§€ -->
            <li class="page-item" th:classappend="${posts.first} ? 'disabled'">
                <a class="page-link" 
                   th:href="@{${pageType == 'my' ? '/posts/my' : (pageType == 'wishlist' ? '/posts/wishlist' : '/posts')}(page=0, search=${search}, 
                           productType=${productType}, status=${status}, schoolId=${schoolId}, sortBy=${sortBy})}">
                    <i class="bi bi-chevron-double-left"></i>
                </a>
            </li>
            
            <!-- ì´ì „ í˜ì´ì§€ -->
            <li class="page-item" th:classappend="${!posts.hasPrevious()} ? 'disabled'">
                <a class="page-link" 
                   th:href="@{${pageType == 'my' ? '/posts/my' : (pageType == 'wishlist' ? '/posts/wishlist' : '/posts')}(page=${posts.number - 1}, search=${search}, 
                           productType=${productType}, status=${status}, schoolId=${schoolId}, sortBy=${sortBy})}">
                    <i class="bi bi-chevron-left"></i>
                </a>
            </li>
            
            <!-- í˜ì´ì§€ ë²ˆí˜¸ (í˜„ì¬ í˜ì´ì§€ ì£¼ë³€ 5ê°œë§Œ í‘œì‹œ) -->
            <li th:each="pageNum : ${#numbers.sequence(0, posts.totalPages - 1)}" 
                class="page-item" 
                th:classappend="${pageNum == posts.number} ? 'active'"
                th:if="${pageNum >= posts.number - 2 and pageNum <= posts.number + 2}">
                <a class="page-link" 
                   th:href="@{${pageType == 'my' ? '/posts/my' : (pageType == 'wishlist' ? '/posts/wishlist' : '/posts')}(page=${pageNum}, search=${search}, 
                           productType=${productType}, status=${status}, schoolId=${schoolId}, sortBy=${sortBy})}"
                   th:text="${pageNum + 1}">1</a>
            </li>
            
            <!-- ë‹¤ìŒ í˜ì´ì§€ -->
            <li class="page-item" th:classappend="${!posts.hasNext()} ? 'disabled'">
                <a class="page-link" 
                   th:href="@{${pageType == 'my' ? '/posts/my' : (pageType == 'wishlist' ? '/posts/wishlist' : '/posts')}(page=${posts.number + 1}, search=${search}, 
                           productType=${productType}, status=${status}, schoolId=${schoolId}, sortBy=${sortBy})}">
                    <i class="bi bi-chevron-right"></i>
                </a>
            </li>
            
            <!-- ë§ˆì§€ë§‰ í˜ì´ì§€ -->
            <li class="page-item" th:classappend="${posts.last} ? 'disabled'">
                <a class="page-link" 
                   th:href="@{${pageType == 'my' ? '/posts/my' : (pageType == 'wishlist' ? '/posts/wishlist' : '/posts')}(page=${posts.totalPages - 1}, search=${search}, 
                           productType=${productType}, status=${status}, schoolId=${schoolId}, sortBy=${sortBy})}">
                    <i class="bi bi-chevron-double-right"></i>
                </a>
            </li>
        </ul>
    </nav>
</div>

<!-- ê³µí†µ Footer í¬í•¨ -->
<footer th:replace="~{fragments/header :: footer}"></footer>

<!-- ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ í¬í•¨ -->
<div th:replace="~{fragments/header :: scripts}"></div>
<script th:src="@{/js/search-highlight.js}"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    // ê²€ìƒ‰ í‚¤ì›Œë“œë¥¼ JavaScript ë³€ìˆ˜ë¡œ ì „ë‹¬
    var searchKeywords = /*[[${searchKeywords}]]*/ null;
    /*]]>*/
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ì´ë¯¸ì§€ ë ˆì´ì§€ ë¡œë”©
        const lazyImages = document.querySelectorAll('img.lazy');
        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.src = img.dataset.src;
                    img.classList.add('loaded');
                    img.classList.remove('lazy');
                    observer.unobserve(img);
                }
            });
        }, {
            rootMargin: '50px 0px',
            threshold: 0.01
        });
        
        lazyImages.forEach(img => imageObserver.observe(img));
        
        // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥ ë° ë³µì›
        const scrollKey = 'posts-list-scroll-' + window.location.pathname;
        const savedScroll = sessionStorage.getItem(scrollKey);
        if (savedScroll) {
            window.scrollTo(0, parseInt(savedScroll));
            sessionStorage.removeItem(scrollKey);
        }
        
        // í˜ì´ì§€ ì´ë™ ì‹œ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥
        document.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', function() {
                sessionStorage.setItem(scrollKey, window.scrollY);
            });
        });
        
        // í˜ì´ì§€ ì „í™˜ íš¨ê³¼
        const pageContainer = document.querySelector('.container');
        document.querySelectorAll('.pagination a, .filter-pill, .sort-links a').forEach(link => {
            link.addEventListener('click', function(e) {
                if (!e.ctrlKey && !e.metaKey) {
                    e.preventDefault();
                    pageContainer.classList.add('page-transition', 'loading');
                    setTimeout(() => {
                        window.location.href = this.href;
                    }, 300);
                }
            });
        });
        
        // ì°œí•˜ê¸° í•˜íŠ¸ ì•„ì´ì½˜ ì´ë²¤íŠ¸ ì²˜ë¦¬
        $('.wishlist-heart-icon').on('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            var postId = $(this).data('post-id');
            var heartIcon = $(this);
            
            // ì•„ì´ì½˜ í´ë¦­ ì¤‘ë³µ ë°©ì§€
            if (heartIcon.hasClass('processing')) {
                return;
            }
            heartIcon.addClass('processing');
            
            $.ajax({
                url: '/api/wishlist/toggle/' + postId,
                type: 'POST',
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                    var csrfHeader = $('meta[name="_csrf_header"]').attr('content');
                    var csrfToken = $('meta[name="_csrf"]').attr('content');
                    if (csrfHeader && csrfToken) {
                        xhr.setRequestHeader(csrfHeader, csrfToken);
                    }
                },
                success: function(response) {
                    if (response.success) {
                        updateWishlistHeartIcon(heartIcon, response.isWishlisted);
                        updateWishlistCountInList(heartIcon, response.isWishlisted);
                        showToast(response.message);
                    } else {
                        showToast(response.message || 'ì°œí•˜ê¸° ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                },
                error: function(xhr) {
                    if (xhr.status === 400) {
                        var response = xhr.responseJSON;
                        showToast(response.message || 'ì°œí•˜ê¸° ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    } else {
                        showToast('ì°œí•˜ê¸° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                },
                complete: function() {
                    heartIcon.removeClass('processing');
                }
            });
        });
        
        // ìì‹ ì˜ ê²Œì‹œê¸€ í•˜íŠ¸ ì•„ì´ì½˜ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
        $('.my-post-heart-icon').on('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            showToast('ìì‹ ì˜ ê²Œì‹œê¸€ì€ ì°œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤ ğŸ˜Š');
        });
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì°œ ìƒíƒœ í™•ì¸
        loadWishlistStatusForList();
        
        // ê²€ìƒ‰ í¼ ì œì¶œ ì‹œ ë¡œë”© í‘œì‹œ
        $('#searchForm').on('submit', function() {
            const button = $('#searchButton');
            button.find('.button-text').text('ê²€ìƒ‰ì¤‘...');
            button.find('.spinner-border').removeClass('d-none');
            button.prop('disabled', true);
        });
        
        // ë¸Œë¼ìš°ì € ë’¤ë¡œê°€ê¸° ì‹œ ë¡œë”© ìƒíƒœ ì´ˆê¸°í™”
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                const button = $('#searchButton');
                button.find('.button-text').text('ê²€ìƒ‰');
                button.find('.spinner-border').addClass('d-none');
                button.prop('disabled', false);
            }
        });
    });
    
    // ì°œí•˜ê¸° í•˜íŠ¸ ì•„ì´ì½˜ UI ì—…ë°ì´íŠ¸ (ëª©ë¡ìš©)
    function updateWishlistHeartIcon(heartIcon, isWishlisted) {
        if (isWishlisted) {
            heartIcon.removeClass('bi-heart').addClass('bi-heart-fill');
            heartIcon.css('color', '#dc3545');
            heartIcon.attr('title', 'ì°œ í•´ì œ');
        } else {
            heartIcon.removeClass('bi-heart-fill').addClass('bi-heart');
            heartIcon.css('color', '#6c757d');
            heartIcon.attr('title', 'ì°œí•˜ê¸°');
        }
    }
    
    // ì°œ ê°œìˆ˜ ì—…ë°ì´íŠ¸ (ëª©ë¡ìš©)
    function updateWishlistCountInList(heartIcon, isWishlisted) {
        var countElement = heartIcon.closest('.ms-2').find('.wishlist-count');
        var currentCount = parseInt(countElement.text()) || 0;
        var newCount = isWishlisted ? currentCount + 1 : Math.max(0, currentCount - 1);
        countElement.text(newCount);
    }
    
    // ëª©ë¡ í˜ì´ì§€ìš© ì°œ ìƒíƒœ ë¡œë“œ
    function loadWishlistStatusForList() {
        $('.wishlist-heart-icon').each(function() {
            var heartIcon = $(this);
            var postId = heartIcon.data('post-id');
            
            $.ajax({
                url: '/api/wishlist/check/' + postId,
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        updateWishlistHeartIcon(heartIcon, response.isWishlisted);
                    }
                },
                error: function(xhr) {
                    console.log('ì°œ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: postId=' + postId);
                }
            });
        });
    }
    
    // í† ìŠ¤íŠ¸ ë©”ì‹œì§€
    function showToast(message) {
        $('.toast-container').remove();
        
        var isWarning = message.includes('ìì‹ ì˜ ê²Œì‹œê¸€') || message.includes('ì´ë©”ì¼ ì¸ì¦');
        var backgroundColor = isWarning ? 'rgba(255, 193, 7, 0.9)' : 'rgba(25, 135, 84, 0.9)';
        var textColor = isWarning ? '#664d03' : '#ffffff';
        
        var toast = $('<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1050;">' +
                      '<div class="toast border-0" role="alert" style="background-color: ' + backgroundColor + '; color: ' + textColor + ';">' +
                      '<div class="toast-body text-center fw-medium">' + message + '</div>' +
                      '</div></div>');
        
        $('body').append(toast);
        
        var bsToast = new bootstrap.Toast(toast.find('.toast')[0], {
            autohide: true,
            delay: isWarning ? 2500 : 2000
        });
        bsToast.show();
        
        setTimeout(function() {
            toast.remove();
        }, isWarning ? 3500 : 3000);
    }
</script>
</body>
</html>