<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>ê²Œì‹œê¸€ ëª©ë¡ - Unibook</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link th:href="@{/css/search-highlight.css}" rel="stylesheet">
    <style>
        .post-card {
            transition: transform 0.2s, box-shadow 0.2s;
            height: 100%;
        }
        
        .post-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .post-image {
            height: 200px;
            object-fit: cover;
            background-color: #f8f9fa;
        }
        
        .no-image {
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            color: #6c757d;
        }
        
        .price {
            font-size: 1.25rem;
            font-weight: bold;
            color: #0d6efd;
        }
        
        .status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1;
        }
        
        .filter-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .filter-toolbar {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .sort-links a {
            color: #6c757d;
            text-decoration: none;
            padding: 0 10px;
            border-right: 1px solid #dee2e6;
            transition: color 0.2s;
        }
        
        .sort-links a:last-child {
            border-right: none;
        }
        
        .sort-links a:hover {
            color: #0d6efd;
        }
        
        .sort-links a.active {
            color: #0d6efd;
            font-weight: 600;
        }
        
        .pagination {
            justify-content: center;
        }
        
        .wishlist-heart-icon {
            transition: all 0.2s ease;
        }
        
        .wishlist-heart-icon:hover {
            transform: scale(1.2);
            color: #dc3545 !important; /* í˜¸ë²„ ì‹œ ë¹¨ê°„ìƒ‰ */
        }
        
        .wishlist-heart-icon.processing {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .my-post-heart-icon {
            transition: all 0.2s ease;
        }
        
        .my-post-heart-icon:hover {
            transform: scale(1.1);
            color: #6c757d !important; /* í˜¸ë²„ ì‹œ ì¡°ê¸ˆ ë” ì§„í•œ íšŒìƒ‰ */
        }
        
        .card-text {
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .author-info {
            font-size: 0.875rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
<!-- ê³µí†µ í—¤ë” í¬í•¨ -->
<nav th:replace="~{fragments/header :: header}"></nav>

<!-- ê³µí†µ ë©”ì‹œì§€ í¬í•¨ -->
<div th:replace="~{fragments/header :: messages}"></div>

<div class="container mt-4">
    
    <!-- í˜ì´ì§€ íƒ€ì´í‹€ -->
    <h2 class="mb-4" th:text="${pageTitle ?: 'ê²Œì‹œê¸€ ëª©ë¡'}">ê²Œì‹œê¸€ ëª©ë¡</h2>
    
    <!-- í•„í„° ë° ì •ë ¬ ì˜µì…˜ -->
    <div class="filter-toolbar">
        <div class="d-flex justify-content-between align-items-center">
            <!-- ìš°ë¦¬ í•™êµ í•„í„° (ì¼ë°˜ ê²Œì‹œê¸€ ëª©ë¡ì—ì„œë§Œ í‘œì‹œ) -->
            <div th:if="${pageType == null}">
                <!-- ì´ë©”ì¼ ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ìš°ë¦¬ í•™êµ í•„í„° ì‚¬ìš© ê°€ëŠ¥ -->
                <div th:if="${userSchoolId != null}" sec:authorize="isAuthenticated()">
                    <form method="get" action="/posts" class="d-flex align-items-center" 
                          th:if="${#authentication.principal.verified}">
                        <input type="hidden" name="search" th:value="${search}">
                        <input type="hidden" name="productType" th:value="${productType}">
                        <input type="hidden" name="status" th:value="${status}">
                        <input type="hidden" name="sortBy" th:value="${sortBy}">
                        
                        <div class="form-check mb-0">
                            <input class="form-check-input" type="checkbox" id="schoolFilter" 
                                   name="schoolId" th:value="${userSchoolId}" 
                                   th:checked="${schoolId == userSchoolId}"
                                   onchange="this.form.submit()">
                            <label class="form-check-label" for="schoolFilter">
                                <i class="bi bi-building-fill"></i> ìš°ë¦¬ í•™êµ ê²Œì‹œê¸€ë§Œ ë³´ê¸°
                            </label>
                        </div>
                    </form>
                    <span class="text-muted" th:unless="${#authentication.principal.verified}">
                        <i class="bi bi-info-circle"></i> ì´ë©”ì¼ ì¸ì¦ í›„ ìš°ë¦¬ í•™êµ í•„í„°ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
                    </span>
                </div>
                <div th:unless="${userSchoolId != null}">
                    <span class="text-muted">ì „ì²´ í•™êµ ê²Œì‹œê¸€</span>
                </div>
            </div>
            <!-- ë‚´ ê²Œì‹œê¸€/ì°œ ëª©ë¡ í˜ì´ì§€ í‘œì‹œ -->
            <div th:if="${pageType != null}">
                <span class="text-muted" th:switch="${pageType}">
                    <span th:case="'my'"><i class="bi bi-person-fill"></i> ë‚´ê°€ ì‘ì„±í•œ ê²Œì‹œê¸€</span>
                    <span th:case="'wishlist'"><i class="bi bi-heart-fill"></i> ë‚´ê°€ ì°œí•œ ê²Œì‹œê¸€</span>
                </span>
            </div>
            
            <!-- ì •ë ¬ ì˜µì…˜ -->
            <div class="d-flex align-items-center sort-links">
                <!-- ë™ì  URL ì„¤ì • -->
                <span th:with="baseUrl=${pageType == 'my' ? '/posts/my' : (pageType == 'wishlist' ? '/posts/wishlist' : '/posts')}">
                    <a th:href="@{${baseUrl}(search=${search}, productType=${productType}, status=${status}, 
                                       schoolId=${schoolId}, sortBy='RELEVANCE')}"
                       th:classappend="${sortBy == 'RELEVANCE' ? 'active' : ''}"
                       th:style="${search == null or search.isEmpty() ? 'display: none;' : ''}">
                        ê´€ë ¨ë„ìˆœ
                    </a>
                    <a th:href="@{${baseUrl}(sortBy='NEWEST')}"
                       th:classappend="${sortBy == 'NEWEST' ? 'active' : ''}">
                        ìµœì‹ ìˆœ
                    </a>
                    <a th:href="@{${baseUrl}(sortBy='PRICE_ASC')}"
                       th:classappend="${sortBy == 'PRICE_ASC' ? 'active' : ''}">
                        ê°€ê²© ë‚®ì€ìˆœ
                    </a>
                    <a th:href="@{${baseUrl}(sortBy='PRICE_DESC')}"
                       th:classappend="${sortBy == 'PRICE_DESC' ? 'active' : ''}">
                        ê°€ê²© ë†’ì€ìˆœ
                    </a>
                    <a th:href="@{${baseUrl}(sortBy='VIEW_COUNT')}"
                       th:classappend="${sortBy == 'VIEW_COUNT' ? 'active' : ''}">
                        ì¡°íšŒìˆ˜ìˆœ
                    </a>
                </span>
            </div>
        </div>
    </div>
    
    <!-- í•„í„° ì„¹ì…˜ -->
    <div class="filter-section">
        <form method="get" th:action="${pageType == 'my' ? '/posts/my' : (pageType == 'wishlist' ? '/posts/wishlist' : '/posts')}" 
              class="row g-3" id="searchForm">
            <div class="col-md-4">
                <label for="search" class="form-label">ê²€ìƒ‰</label>
                <input type="text" class="form-control" id="search" name="search" 
                       th:value="${search}" placeholder="ì œëª©, ë‚´ìš©, ê³¼ëª©, êµìˆ˜ ê²€ìƒ‰">
            </div>
            <div class="col-md-3">
                <label for="productType" class="form-label">ìƒí’ˆ ìœ í˜•</label>
                <select class="form-select" id="productType" name="productType">
                    <option value="">ì „ì²´</option>
                    <option th:each="type : ${productTypes}" 
                            th:value="${type}" 
                            th:selected="${type == productType}"
                            th:text="${type.name() == 'TEXTBOOK' ? 'ì „ê³µêµì¬' : 
                                     type.name() == 'CERTBOOK' ? 'ìê²©ì¦ êµì¬' :
                                     type.name() == 'NOTE' ? 'í•„ê¸°ë…¸íŠ¸' :
                                     type.name() == 'PASTEXAM' ? 'ì¡±ë³´/ê¸°ì¶œ' : 'ê¸°íƒ€'}"></option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="status" class="form-label">ê±°ë˜ ìƒíƒœ</label>
                <select class="form-select" id="status" name="status">
                    <option value="">ì „ì²´</option>
                    <option value="AVAILABLE" th:selected="${status == 'AVAILABLE'}">íŒë§¤ì¤‘</option>
                    <option value="RESERVED" th:selected="${status == 'RESERVED'}">ì˜ˆì•½ì¤‘</option>
                    <option value="COMPLETED" th:selected="${status == 'COMPLETED'}">ê±°ë˜ì™„ë£Œ</option>
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search"></i> ê²€ìƒ‰
                </button>
            </div>
            <!-- í•™êµ í•„í„° ìœ ì§€ë¥¼ ìœ„í•œ hidden input -->
            <input type="hidden" name="schoolId" th:value="${schoolId}">
            <!-- sortByëŠ” ì œê±°í•˜ì—¬ ê²€ìƒ‰ ì‹œ ìë™ìœ¼ë¡œ ê´€ë ¨ë„ìˆœì´ ë˜ë„ë¡ í•¨ -->
        </form>
    </div>
    
    <!-- ê²€ìƒ‰ ì •ë³´ í‘œì‹œ -->
    <div th:if="${search != null and !search.isEmpty()}" class="search-info mb-4">
        <i class="bi bi-search"></i> 
        "<span class="search-term" th:text="${search}"></span>" ê²€ìƒ‰ ê²°ê³¼ 
        <span th:text="${posts.totalElements}">0</span>ê°œ
    </div>
    
    <!-- ê²Œì‹œê¸€ ëª©ë¡ -->
    <div th:if="${posts.content.isEmpty()}" class="text-center py-5">
        <i class="bi bi-inbox fs-1 text-muted"></i>
        <!-- pageTypeì— ë”°ë¥¸ ë©”ì‹œì§€ ë¶„ê¸° -->
        <div th:switch="${pageType}">
            <!-- ë‚´ ê²Œì‹œê¸€ -->
            <div th:case="'my'">
                <p class="mt-3 text-muted">ì•„ì§ ì‘ì„±í•œ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                <div sec:authorize="isAuthenticated()">
                    <a href="/posts/new" class="btn btn-primary" th:if="${#authentication.principal.verified}">
                        ì²« ê²Œì‹œê¸€ ì‘ì„±í•˜ê¸°
                    </a>
                    <div th:unless="${#authentication.principal.verified}">
                        <p class="text-muted">ê²Œì‹œê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ <a href="/verification-required">ì´ë©”ì¼ ì¸ì¦</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
            <!-- ì°œ ëª©ë¡ -->
            <div th:case="'wishlist'">
                <p class="mt-3 text-muted">ì•„ì§ ì°œí•œ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                <div sec:authorize="isAuthenticated()">
                    <a href="/posts" class="btn btn-primary">ê²Œì‹œê¸€ ë‘˜ëŸ¬ë³´ê¸°</a>
                    <div th:unless="${#authentication.principal.verified}">
                        <p class="text-muted mt-2">ì°œí•˜ê¸° ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ <a href="/verification-required">ì´ë©”ì¼ ì¸ì¦</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
            <!-- ì¼ë°˜ ëª©ë¡ -->
            <div th:case="*">
                <p class="mt-3 text-muted">ë“±ë¡ëœ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                <a href="/posts/new" class="btn btn-primary" sec:authorize="isAuthenticated()">
                    ì²« ê²Œì‹œê¸€ ì‘ì„±í•˜ê¸°
                </a>
            </div>
        </div>
    </div>
    
    <div th:if="${!posts.content.isEmpty()}" class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-4">
        <div th:each="post : ${posts.content}" class="col">
            <div class="card post-card">
                <!-- ìƒíƒœ ë°°ì§€ -->
                <span class="badge status-badge"
                      th:classappend="${post.status.toString() == 'AVAILABLE' ? 'bg-success' : 
                                      post.status.toString() == 'RESERVED' ? 'bg-warning text-dark' : 
                                      'bg-secondary'}"
                      th:text="${post.status.toString() == 'AVAILABLE' ? 'íŒë§¤ì¤‘' : 
                               post.status.toString() == 'RESERVED' ? 'ì˜ˆì•½ì¤‘' : 
                               'ê±°ë˜ì™„ë£Œ'}"></span>
                
                <!-- ì´ë¯¸ì§€ -->
                <a th:href="@{/posts/{id}(id=${post.postId})}" class="text-decoration-none">
                    <img th:if="${post.images != null and !post.images.isEmpty()}" 
                         th:src="@{${post.images[0].imagePath}}" 
                         class="card-img-top post-image" 
                         alt="ìƒí’ˆ ì´ë¯¸ì§€">
                    <div th:if="${post.images == null or post.images.isEmpty()}" class="no-image">
                        <i class="bi bi-image fs-1"></i>
                    </div>
                </a>
                
                <div class="card-body">
                    <!-- ìƒí’ˆ ìœ í˜• -->
                    <small class="text-muted">
                        <span th:text="${post.productType.name() == 'TEXTBOOK' ? 'ì „ê³µêµì¬' : 
                                       post.productType.name() == 'CERTBOOK' ? 'ìê²©ì¦ êµì¬' :
                                       post.productType.name() == 'NOTE' ? 'í•„ê¸°ë…¸íŠ¸' :
                                       post.productType.name() == 'PASTEXAM' ? 'ì¡±ë³´/ê¸°ì¶œ' : 'ê¸°íƒ€'}"></span>
                    </small>
                    
                    <!-- ì œëª© -->
                    <h5 class="card-title mt-2">
                        <a th:href="@{/posts/{id}(id=${post.postId})}" 
                           class="text-decoration-none text-dark post-title"
                           th:text="${post.title}">ì œëª©</a>
                    </h5>
                    
                    <!-- ê°€ê²© -->
                    <p class="price mb-2" th:text="${#numbers.formatInteger(post.price, 0, 'COMMA') + 'ì›'}">0ì›</p>
                    
                    <!-- ê³¼ëª©/êµìˆ˜ ì •ë³´ (ìˆì„ ê²½ìš°) -->
                    <div th:if="${post.subjectName != null}" class="subject-info mb-2">
                        <small class="text-muted">
                            <i class="bi bi-book"></i>
                            <span class="post-subject-name" th:text="${post.subjectName}">ê³¼ëª©ëª…</span>
                            <span th:if="${post.professorName != null}">
                                Â· <span class="post-professor-name" th:text="${post.professorName}">êµìˆ˜ëª…</span>
                            </span>
                        </small>
                    </div>
                    
                    <!-- ì±… ì •ë³´ (ìˆì„ ê²½ìš°) -->
                    <div th:if="${post.bookTitle != null}" class="book-info mb-2">
                        <small class="text-muted">
                            <i class="bi bi-journal-text"></i>
                            <span class="post-book-title" th:text="${post.bookTitle}">ì±… ì œëª©</span>
                            <span th:if="${post.bookAuthor != null}">
                                Â· <span class="post-book-author" th:text="${post.bookAuthor}">ì €ì</span>
                            </span>
                        </small>
                    </div>
                    
                    <!-- ì‘ì„±ì ì •ë³´ -->
                    <div class="author-info">
                        <i class="bi bi-person"></i> 
                        <span th:text="${post.user.name}">ì‘ì„±ì</span>
                        <span th:if="${post.user.departmentName != null}">
                            Â· <span th:text="${post.user.departmentName}">í•™ê³¼</span>
                        </span>
                    </div>
                    
                    <!-- ì¶”ê°€ ì •ë³´ -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <small class="text-muted">
                            <i class="bi bi-eye"></i> <span th:text="${post.viewCount}">0</span>
                            
                            <!-- ì°œí•˜ê¸° í•˜íŠ¸ ì•„ì´ì½˜ (ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ, íƒ€ì¸ì˜ ê²Œì‹œê¸€) -->
                            <span sec:authorize="isAuthenticated()" 
                                  th:if="${post.user.userId != #authentication.principal.userId}">
                                <i class="bi bi-heart ms-2 wishlist-heart-icon" 
                                   style="cursor: pointer; font-size: 1.1em; color: #6c757d;"
                                   th:data-post-id="${post.postId}"
                                   title="ì°œí•˜ê¸°"></i>
                            </span>
                            <!-- ìì‹ ì˜ ê²Œì‹œê¸€ì¸ ê²½ìš° í´ë¦­ ê°€ëŠ¥í•˜ì§€ë§Œ ë¹„í™œì„±í™”ëœ í•˜íŠ¸ -->
                            <span sec:authorize="isAuthenticated()" 
                                  th:if="${post.user.userId == #authentication.principal.userId}">
                                <i class="bi bi-heart ms-2 my-post-heart-icon" 
                                   style="cursor: pointer; font-size: 1.1em; color: #adb5bd;"
                                   th:data-post-id="${post.postId}"
                                   title="ë‚´ ê²Œì‹œê¸€"></i>
                            </span>
                            <!-- ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ìì¸ ê²½ìš° ì¼ë°˜ í•˜íŠ¸ -->
                            <span sec:authorize="!isAuthenticated()">
                                <i class="bi bi-heart ms-2 text-muted"></i>
                            </span>
                            
                            <span th:text="${post.wishlistCount}" class="wishlist-count">0</span>
                        </small>
                        <small class="text-muted" 
                               th:text="${#temporals.format(post.createdAt, 'MM.dd')}">01.01</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
    <nav th:if="${posts.totalPages > 1}" class="mt-5">
        <ul class="pagination">
            <!-- ì´ì „ í˜ì´ì§€ -->
            <li class="page-item" th:classappend="${!posts.hasPrevious()} ? 'disabled'">
                <a class="page-link" 
                   th:href="@{/posts(page=${posts.number - 1}, search=${search}, 
                           productType=${productType}, status=${status}, schoolId=${schoolId}, sortBy=${sortBy})}"
                   tabindex="-1">ì´ì „</a>
            </li>
            
            <!-- í˜ì´ì§€ ë²ˆí˜¸ -->
            <li th:each="pageNum : ${#numbers.sequence(0, posts.totalPages - 1)}" 
                class="page-item" 
                th:classappend="${pageNum == posts.number} ? 'active'"
                th:if="${pageNum >= posts.number - 2 and pageNum <= posts.number + 2}">
                <a class="page-link" 
                   th:href="@{/posts(page=${pageNum}, search=${search}, 
                           productType=${productType}, status=${status}, schoolId=${schoolId}, sortBy=${sortBy})}"
                   th:text="${pageNum + 1}">1</a>
            </li>
            
            <!-- ë‹¤ìŒ í˜ì´ì§€ -->
            <li class="page-item" th:classappend="${!posts.hasNext()} ? 'disabled'">
                <a class="page-link" 
                   th:href="@{/posts(page=${posts.number + 1}, search=${search}, 
                           productType=${productType}, status=${status}, schoolId=${schoolId}, sortBy=${sortBy})}">ë‹¤ìŒ</a>
            </li>
        </ul>
    </nav>
</div>

<!-- ê³µí†µ Footer í¬í•¨ -->
<footer th:replace="~{fragments/header :: footer}"></footer>

<!-- ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ í¬í•¨ -->
<div th:replace="~{fragments/header :: scripts}"></div>
<script th:src="@{/js/search-highlight.js}"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    // ê²€ìƒ‰ í‚¤ì›Œë“œë¥¼ JavaScript ë³€ìˆ˜ë¡œ ì „ë‹¬
    var searchKeywords = /*[[${searchKeywords}]]*/ null;
    /*]]>*/
</script>
<script>
    // í•™êµ í•„í„°ëŠ” ì´ë¯¸ onchangeë¡œ ì²˜ë¦¬ë˜ë¯€ë¡œ ì¶”ê°€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë¶ˆí•„ìš”
    
    // ê²€ìƒ‰ì–´ê°€ ì—†ì„ ë•Œ ê´€ë ¨ë„ìˆœ ë§í¬ ìˆ¨ê¸°ê¸°
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('search');
        const relevanceLink = document.querySelector('.sort-links a[href*="sortBy=\'RELEVANCE\'"]');
        
        function updateSortOptions() {
            const hasSearch = searchInput.value.trim().length > 0;
            
            if (relevanceLink) {
                relevanceLink.style.display = hasSearch ? 'inline' : 'none';
            }
        }
        
        // ì´ˆê¸° ìƒíƒœ ì„¤ì •
        updateSortOptions();
        
        // ê²€ìƒ‰ì–´ ì…ë ¥ ì‹œ ì—…ë°ì´íŠ¸
        searchInput.addEventListener('input', updateSortOptions);
        
        // ì°œí•˜ê¸° í•˜íŠ¸ ì•„ì´ì½˜ ì´ë²¤íŠ¸ ì²˜ë¦¬
        $('.wishlist-heart-icon').on('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            var postId = $(this).data('post-id');
            var heartIcon = $(this);
            
            console.log('ì°œí•˜ê¸° í•˜íŠ¸ í´ë¦­, postId:', postId);
            
            // ì•„ì´ì½˜ í´ë¦­ ì¤‘ë³µ ë°©ì§€
            if (heartIcon.hasClass('processing')) {
                return;
            }
            heartIcon.addClass('processing');
            
            $.ajax({
                url: '/api/wishlist/toggle/' + postId,
                type: 'POST',
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                    var csrfHeader = $('meta[name="_csrf_header"]').attr('content');
                    var csrfToken = $('meta[name="_csrf"]').attr('content');
                    if (csrfHeader && csrfToken) {
                        xhr.setRequestHeader(csrfHeader, csrfToken);
                    }
                },
                success: function(response) {
                    console.log('ì°œí•˜ê¸° ì‘ë‹µ:', response);
                    if (response.success) {
                        updateWishlistHeartIcon(heartIcon, response.isWishlisted);
                        updateWishlistCountInList(heartIcon, response.isWishlisted);
                        showToast(response.message);
                    } else {
                        alert(response.message || 'ì°œí•˜ê¸° ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                },
                error: function(xhr) {
                    console.error('ì°œí•˜ê¸° ì—ëŸ¬:', xhr.status, xhr.responseText);
                    if (xhr.status === 400) {
                        var response = xhr.responseJSON;
                        if (response.needVerification) {
                            // ì´ë©”ì¼ ì¸ì¦ í•„ìš”í•œ ê²½ìš° ë…¸ë€ìƒ‰ Toast
                            showToast(response.message || 'ì´ë©”ì¼ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                        } else {
                            alert(response.message || 'ì°œí•˜ê¸° ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                    } else {
                        alert('ì°œí•˜ê¸° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                },
                complete: function() {
                    heartIcon.removeClass('processing');
                }
            });
        });
        
        // ìì‹ ì˜ ê²Œì‹œê¸€ í•˜íŠ¸ ì•„ì´ì½˜ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
        $('.my-post-heart-icon').on('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('ë‚´ ê²Œì‹œê¸€ í•˜íŠ¸ í´ë¦­');
            showToast('ìì‹ ì˜ ê²Œì‹œê¸€ì€ ì°œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤ ğŸ˜Š');
        });
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì°œ ìƒíƒœ í™•ì¸
        loadWishlistStatusForList();
    });
    
    // ì°œí•˜ê¸° í•˜íŠ¸ ì•„ì´ì½˜ UI ì—…ë°ì´íŠ¸ (ëª©ë¡ìš©)
    function updateWishlistHeartIcon(heartIcon, isWishlisted) {
        if (isWishlisted) {
            heartIcon.removeClass('bi-heart').addClass('bi-heart-fill');
            heartIcon.css('color', '#dc3545'); // Bootstrap danger color
            heartIcon.attr('title', 'ì°œ í•´ì œ');
        } else {
            heartIcon.removeClass('bi-heart-fill').addClass('bi-heart');
            heartIcon.css('color', '#6c757d'); // Bootstrap secondary color
            heartIcon.attr('title', 'ì°œí•˜ê¸°');
        }
    }
    
    // ì°œ ê°œìˆ˜ ì—…ë°ì´íŠ¸ (ëª©ë¡ìš©)
    function updateWishlistCountInList(heartIcon, isWishlisted) {
        var countElement = heartIcon.closest('.text-muted').find('.wishlist-count');
        var currentCount = parseInt(countElement.text()) || 0;
        var newCount = isWishlisted ? currentCount + 1 : Math.max(0, currentCount - 1);
        countElement.text(newCount);
    }
    
    // ëª©ë¡ í˜ì´ì§€ìš© ì°œ ìƒíƒœ ë¡œë“œ
    function loadWishlistStatusForList() {
        $('.wishlist-heart-icon').each(function() {
            var heartIcon = $(this);
            var postId = heartIcon.data('post-id');
            
            $.ajax({
                url: '/api/wishlist/check/' + postId,
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        updateWishlistHeartIcon(heartIcon, response.isWishlisted);
                    }
                },
                error: function(xhr) {
                    console.log('ì°œ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: postId=' + postId);
                }
            });
        });
    }
    
    // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ (ëª©ë¡ìš©)
    function showToast(message) {
        $('.toast-container').remove();
        
        var isWarning = message.includes('ìì‹ ì˜ ê²Œì‹œê¸€') || message.includes('ì´ë©”ì¼ ì¸ì¦');
        var backgroundColor = isWarning ? 'rgba(255, 193, 7, 0.9)' : 'rgba(25, 135, 84, 0.9)'; // íˆ¬ëª…ë„ 90%
        var textColor = isWarning ? '#664d03' : '#ffffff';
        
        var toast = $('<div class="toast-container position-fixed top-0 end-0 p-3">' +
                      '<div class="toast border-0" role="alert" style="background-color: ' + backgroundColor + '; color: ' + textColor + ';">' +
                      '<div class="toast-body text-center fw-medium">' + message + '</div>' +
                      '</div></div>');
        
        $('body').append(toast);
        
        var bsToast = new bootstrap.Toast(toast.find('.toast')[0], {
            autohide: true,
            delay: isWarning ? 2500 : 2000
        });
        bsToast.show();
        
        setTimeout(function() {
            toast.remove();
        }, isWarning ? 3500 : 3000);
    }
</script>
</body>
</html>