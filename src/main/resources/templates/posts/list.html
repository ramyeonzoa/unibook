<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시글 목록 - Unibook</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link th:href="@{/css/search-highlight.css}" rel="stylesheet">
    <style>
        .post-card {
            transition: transform 0.2s, box-shadow 0.2s;
            height: 100%;
        }
        
        .post-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .post-image {
            height: 200px;
            object-fit: cover;
            background-color: #f8f9fa;
        }
        
        .no-image {
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            color: #6c757d;
        }
        
        .price {
            font-size: 1.25rem;
            font-weight: bold;
            color: #0d6efd;
        }
        
        .status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1;
        }
        
        .filter-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .filter-toolbar {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .sort-links a {
            color: #6c757d;
            text-decoration: none;
            padding: 0 10px;
            border-right: 1px solid #dee2e6;
            transition: color 0.2s;
        }
        
        .sort-links a:last-child {
            border-right: none;
        }
        
        .sort-links a:hover {
            color: #0d6efd;
        }
        
        .sort-links a.active {
            color: #0d6efd;
            font-weight: 600;
        }
        
        .pagination {
            justify-content: center;
        }
        
        .card-text {
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .author-info {
            font-size: 0.875rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
<!-- 공통 헤더 포함 -->
<nav th:replace="~{fragments/header :: header}"></nav>

<!-- 공통 메시지 포함 -->
<div th:replace="~{fragments/header :: messages}"></div>

<div class="container mt-4">
    
    <h2 class="mb-4">게시글 목록</h2>
    
    <!-- 필터 및 정렬 옵션 -->
    <div class="filter-toolbar">
        <div class="d-flex justify-content-between align-items-center">
            <!-- 우리 학교 필터 -->
            <div th:if="${userSchoolId != null}">
                <form method="get" action="/posts" class="d-flex align-items-center">
                    <input type="hidden" name="search" th:value="${search}">
                    <input type="hidden" name="productType" th:value="${productType}">
                    <input type="hidden" name="status" th:value="${status}">
                    <input type="hidden" name="sortBy" th:value="${sortBy}">
                    
                    <div class="form-check mb-0">
                        <input class="form-check-input" type="checkbox" id="schoolFilter" 
                               name="schoolId" th:value="${userSchoolId}" 
                               th:checked="${schoolId == userSchoolId}"
                               onchange="this.form.submit()">
                        <label class="form-check-label" for="schoolFilter">
                            <i class="bi bi-building-fill"></i> 우리 학교 게시글만 보기
                        </label>
                    </div>
                </form>
            </div>
            <div th:if="${userSchoolId == null}">
                <span class="text-muted">전체 학교 게시글</span>
            </div>
            
            <!-- 정렬 옵션 -->
            <div class="d-flex align-items-center sort-links">
                <a th:href="@{/posts(search=${search}, productType=${productType}, status=${status}, 
                                   schoolId=${schoolId}, sortBy='RELEVANCE')}"
                   th:classappend="${sortBy == 'RELEVANCE' ? 'active' : ''}"
                   th:style="${search == null or search.isEmpty() ? 'display: none;' : ''}">
                    관련도순
                </a>
                <a th:href="@{/posts(search=${search}, productType=${productType}, status=${status}, 
                                   schoolId=${schoolId}, sortBy='NEWEST')}"
                   th:classappend="${sortBy == 'NEWEST' ? 'active' : ''}">
                    최신순
                </a>
                <a th:href="@{/posts(search=${search}, productType=${productType}, status=${status}, 
                                   schoolId=${schoolId}, sortBy='PRICE_ASC')}"
                   th:classappend="${sortBy == 'PRICE_ASC' ? 'active' : ''}">
                    가격 낮은순
                </a>
                <a th:href="@{/posts(search=${search}, productType=${productType}, status=${status}, 
                                   schoolId=${schoolId}, sortBy='PRICE_DESC')}"
                   th:classappend="${sortBy == 'PRICE_DESC' ? 'active' : ''}">
                    가격 높은순
                </a>
                <a th:href="@{/posts(search=${search}, productType=${productType}, status=${status}, 
                                   schoolId=${schoolId}, sortBy='VIEW_COUNT')}"
                   th:classappend="${sortBy == 'VIEW_COUNT' ? 'active' : ''}">
                    조회수순
                </a>
            </div>
        </div>
    </div>
    
    <!-- 필터 섹션 -->
    <div class="filter-section">
        <form method="get" action="/posts" class="row g-3" id="searchForm">
            <div class="col-md-4">
                <label for="search" class="form-label">검색</label>
                <input type="text" class="form-control" id="search" name="search" 
                       th:value="${search}" placeholder="제목, 내용, 과목, 교수 검색">
            </div>
            <div class="col-md-3">
                <label for="productType" class="form-label">상품 유형</label>
                <select class="form-select" id="productType" name="productType">
                    <option value="">전체</option>
                    <option th:each="type : ${productTypes}" 
                            th:value="${type}" 
                            th:selected="${type == productType}"
                            th:text="${type.name() == 'TEXTBOOK' ? '전공교재' : 
                                     type.name() == 'CERTBOOK' ? '자격증 교재' :
                                     type.name() == 'NOTE' ? '필기노트' :
                                     type.name() == 'PASTEXAM' ? '족보/기출' : '기타'}"></option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="status" class="form-label">거래 상태</label>
                <select class="form-select" id="status" name="status">
                    <option value="">전체</option>
                    <option value="AVAILABLE" th:selected="${status == 'AVAILABLE'}">판매중</option>
                    <option value="RESERVED" th:selected="${status == 'RESERVED'}">예약중</option>
                    <option value="COMPLETED" th:selected="${status == 'COMPLETED'}">거래완료</option>
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search"></i> 검색
                </button>
            </div>
            <!-- 학교 필터 유지를 위한 hidden input -->
            <input type="hidden" name="schoolId" th:value="${schoolId}">
            <!-- sortBy는 제거하여 검색 시 자동으로 관련도순이 되도록 함 -->
        </form>
    </div>
    
    <!-- 검색 정보 표시 -->
    <div th:if="${search != null and !search.isEmpty()}" class="search-info mb-4">
        <i class="bi bi-search"></i> 
        "<span class="search-term" th:text="${search}"></span>" 검색 결과 
        <span th:text="${posts.totalElements}">0</span>개
    </div>
    
    <!-- 게시글 목록 -->
    <div th:if="${posts.content.isEmpty()}" class="text-center py-5">
        <i class="bi bi-inbox fs-1 text-muted"></i>
        <p class="mt-3 text-muted">등록된 게시글이 없습니다.</p>
        <a href="/posts/new" class="btn btn-primary" sec:authorize="isAuthenticated()">
            첫 게시글 작성하기
        </a>
    </div>
    
    <div th:if="${!posts.content.isEmpty()}" class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-4">
        <div th:each="post : ${posts.content}" class="col">
            <div class="card post-card">
                <!-- 상태 배지 -->
                <span class="badge status-badge"
                      th:classappend="${post.status.toString() == 'AVAILABLE' ? 'bg-success' : 
                                      post.status.toString() == 'RESERVED' ? 'bg-warning text-dark' : 
                                      'bg-secondary'}"
                      th:text="${post.status.toString() == 'AVAILABLE' ? '판매중' : 
                               post.status.toString() == 'RESERVED' ? '예약중' : 
                               '거래완료'}"></span>
                
                <!-- 이미지 -->
                <a th:href="@{/posts/{id}(id=${post.postId})}" class="text-decoration-none">
                    <img th:if="${post.images != null and !post.images.isEmpty()}" 
                         th:src="@{${post.images[0].imagePath}}" 
                         class="card-img-top post-image" 
                         alt="상품 이미지">
                    <div th:if="${post.images == null or post.images.isEmpty()}" class="no-image">
                        <i class="bi bi-image fs-1"></i>
                    </div>
                </a>
                
                <div class="card-body">
                    <!-- 상품 유형 -->
                    <small class="text-muted">
                        <span th:text="${post.productType.name() == 'TEXTBOOK' ? '전공교재' : 
                                       post.productType.name() == 'CERTBOOK' ? '자격증 교재' :
                                       post.productType.name() == 'NOTE' ? '필기노트' :
                                       post.productType.name() == 'PASTEXAM' ? '족보/기출' : '기타'}"></span>
                    </small>
                    
                    <!-- 제목 -->
                    <h5 class="card-title mt-2">
                        <a th:href="@{/posts/{id}(id=${post.postId})}" 
                           class="text-decoration-none text-dark post-title"
                           th:text="${post.title}">제목</a>
                    </h5>
                    
                    <!-- 가격 -->
                    <p class="price mb-2" th:text="${#numbers.formatInteger(post.price, 0, 'COMMA') + '원'}">0원</p>
                    
                    <!-- 과목/교수 정보 (있을 경우) -->
                    <div th:if="${post.subjectName != null}" class="subject-info mb-2">
                        <small class="text-muted">
                            <i class="bi bi-book"></i>
                            <span class="post-subject-name" th:text="${post.subjectName}">과목명</span>
                            <span th:if="${post.professorName != null}">
                                · <span class="post-professor-name" th:text="${post.professorName}">교수명</span>
                            </span>
                        </small>
                    </div>
                    
                    <!-- 책 정보 (있을 경우) -->
                    <div th:if="${post.bookTitle != null}" class="book-info mb-2">
                        <small class="text-muted">
                            <i class="bi bi-journal-text"></i>
                            <span class="post-book-title" th:text="${post.bookTitle}">책 제목</span>
                            <span th:if="${post.bookAuthor != null}">
                                · <span class="post-book-author" th:text="${post.bookAuthor}">저자</span>
                            </span>
                        </small>
                    </div>
                    
                    <!-- 작성자 정보 -->
                    <div class="author-info">
                        <i class="bi bi-person"></i> 
                        <span th:text="${post.user.name}">작성자</span>
                        <span th:if="${post.user.departmentName != null}">
                            · <span th:text="${post.user.departmentName}">학과</span>
                        </span>
                    </div>
                    
                    <!-- 추가 정보 -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <small class="text-muted">
                            <i class="bi bi-eye"></i> <span th:text="${post.viewCount}">0</span>
                            <i class="bi bi-heart ms-2"></i> <span th:text="${post.wishlistCount}">0</span>
                        </small>
                        <small class="text-muted" 
                               th:text="${#temporals.format(post.createdAt, 'MM.dd')}">01.01</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 페이지네이션 -->
    <nav th:if="${posts.totalPages > 1}" class="mt-5">
        <ul class="pagination">
            <!-- 이전 페이지 -->
            <li class="page-item" th:classappend="${!posts.hasPrevious()} ? 'disabled'">
                <a class="page-link" 
                   th:href="@{/posts(page=${posts.number - 1}, search=${search}, 
                           productType=${productType}, status=${status}, schoolId=${schoolId}, sortBy=${sortBy})}"
                   tabindex="-1">이전</a>
            </li>
            
            <!-- 페이지 번호 -->
            <li th:each="pageNum : ${#numbers.sequence(0, posts.totalPages - 1)}" 
                class="page-item" 
                th:classappend="${pageNum == posts.number} ? 'active'"
                th:if="${pageNum >= posts.number - 2 and pageNum <= posts.number + 2}">
                <a class="page-link" 
                   th:href="@{/posts(page=${pageNum}, search=${search}, 
                           productType=${productType}, status=${status}, schoolId=${schoolId}, sortBy=${sortBy})}"
                   th:text="${pageNum + 1}">1</a>
            </li>
            
            <!-- 다음 페이지 -->
            <li class="page-item" th:classappend="${!posts.hasNext()} ? 'disabled'">
                <a class="page-link" 
                   th:href="@{/posts(page=${posts.number + 1}, search=${search}, 
                           productType=${productType}, status=${status}, schoolId=${schoolId}, sortBy=${sortBy})}">다음</a>
            </li>
        </ul>
    </nav>
</div>

<!-- 공통 Footer 포함 -->
<footer th:replace="~{fragments/header :: footer}"></footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script th:src="@{/js/search-highlight.js}"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    // 검색 키워드를 JavaScript 변수로 전달
    var searchKeywords = /*[[${searchKeywords}]]*/ null;
    /*]]>*/
</script>
<script>
    // 학교 필터는 이미 onchange로 처리되므로 추가 이벤트 리스너 불필요
    
    // 검색어가 없을 때 관련도순 링크 숨기기
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('search');
        const relevanceLink = document.querySelector('.sort-links a[href*="sortBy=\'RELEVANCE\'"]');
        
        function updateSortOptions() {
            const hasSearch = searchInput.value.trim().length > 0;
            
            if (relevanceLink) {
                relevanceLink.style.display = hasSearch ? 'inline' : 'none';
            }
        }
        
        // 초기 상태 설정
        updateSortOptions();
        
        // 검색어 입력 시 업데이트
        searchInput.addEventListener('input', updateSortOptions);
    });
</script>
</body>
</html>