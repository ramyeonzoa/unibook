<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입 - Unibook</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- jQuery UI CSS -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    
    <style>
        .signup-container {
            max-width: 500px;
            margin: 50px auto;
            padding: 30px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            border-radius: 10px;
            background-color: white;
        }
        .form-label {
            font-weight: 600;
            color: #333;
        }
        .form-control:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 0 0.2rem rgba(76, 175, 80, 0.25);
        }
        .btn-primary {
            background-color: #4CAF50;
            border-color: #4CAF50;
            padding: 10px 30px;
        }
        .btn-primary:hover {
            background-color: #45a049;
            border-color: #45a049;
        }
        .error-message {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        .ui-autocomplete {
            max-height: 300px;
            overflow-y: auto;
            overflow-x: hidden;
        }
        .password-requirements {
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        .password-requirements small {
            color: #6c757d;
            transition: color 0.3s;
        }
        .password-requirements small.valid {
            color: #28a745;
        }
        .requirement-icon {
            display: inline-block;
            width: 1em;
        }
    </style>
</head>
<body class="bg-light">

<div class="container">
    <div class="signup-container">
        <h2 class="text-center mb-4">회원가입</h2>
        
        <form th:action="@{/signup}" method="post" th:object="${signupForm}" id="signupForm">
            
            <!-- 이메일 입력 -->
            <div class="mb-3">
                <label for="email" class="form-label">이메일 (대학교 이메일)</label>
                <input type="email" 
                       class="form-control" 
                       id="email" 
                       th:field="*{email}" 
                       placeholder="student@university.ac.kr"
                       required>
                <div th:if="${#fields.hasErrors('email')}" 
                     th:errors="*{email}" 
                     class="error-message"></div>
                <div id="emailCheckMessage"></div>
            </div>
            
            <!-- 비밀번호 입력 -->
            <div class="mb-3">
                <label for="password" class="form-label">비밀번호</label>
                <input type="password" 
                       class="form-control" 
                       id="password" 
                       th:field="*{password}" 
                       required>
                <div class="password-requirements" id="passwordRequirements">
                    <small class="d-block" id="lengthCheck">
                        <span class="requirement-icon">❌</span> 8자 이상
                    </small>
                    <small class="d-block" id="letterCheck">
                        <span class="requirement-icon">❌</span> 영문 포함
                    </small>
                    <small class="d-block" id="numberCheck">
                        <span class="requirement-icon">❌</span> 숫자 포함
                    </small>
                    <small class="d-block" id="specialCheck">
                        <span class="requirement-icon">❌</span> 특수문자 포함
                    </small>
                </div>
                <div th:if="${#fields.hasErrors('password')}" 
                     th:errors="*{password}" 
                     class="error-message"></div>
            </div>
            
            <!-- 비밀번호 확인 -->
            <div class="mb-3">
                <label for="passwordConfirm" class="form-label">비밀번호 확인</label>
                <input type="password" 
                       class="form-control" 
                       id="passwordConfirm" 
                       th:field="*{passwordConfirm}" 
                       required>
                <div th:if="${#fields.hasErrors('passwordConfirm')}" 
                     th:errors="*{passwordConfirm}" 
                     class="error-message"></div>
            </div>
            
            <!-- 이름 입력 -->
            <div class="mb-3">
                <label for="name" class="form-label">이름</label>
                <input type="text" 
                       class="form-control" 
                       id="name" 
                       th:field="*{name}" 
                       placeholder="홍길동"
                       required>
                <div th:if="${#fields.hasErrors('name')}" 
                     th:errors="*{name}" 
                     class="error-message"></div>
            </div>
            
            <!-- 전화번호 입력 -->
            <div class="mb-3">
                <label for="phoneNumber" class="form-label">전화번호</label>
                <input type="tel" 
                       class="form-control" 
                       id="phoneNumber" 
                       th:field="*{phoneNumber}" 
                       placeholder="010-1234-5678"
                       required>
                <div th:if="${#fields.hasErrors('phoneNumber')}" 
                     th:errors="*{phoneNumber}" 
                     class="error-message"></div>
            </div>
            
            <!-- 학교-학과 선택 -->
            <div class="mb-4">
                <label for="departmentSearch" class="form-label">학교 및 학과</label>
                <input type="text" 
                       class="form-control" 
                       id="departmentSearch" 
                       placeholder="학교명을 입력하세요"
                       th:attr="data-selected-text=${signupForm.departmentId != null ? selectedDepartmentText : ''}"
                       required>
                <input type="hidden" 
                       id="departmentId" 
                       th:field="*{departmentId}">
                <div th:if="${#fields.hasErrors('departmentId')}" 
                     th:errors="*{departmentId}" 
                     class="error-message"></div>
                <div id="selectedDepartment" class="mt-2">
                    <div th:if="${selectedDepartmentText != null}" class="alert alert-info py-2">
                        <strong>선택됨:</strong> <span th:text="${selectedDepartmentText}"></span>
                    </div>
                </div>
            </div>
            
            <!-- 제출 버튼 -->
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary">회원가입</button>
            </div>
            
            <!-- 로그인 링크 -->
            <div class="text-center mt-3">
                이미 계정이 있으신가요? 
                <a th:href="@{/login}" class="text-decoration-none">로그인</a>
            </div>
        </form>
    </div>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- jQuery UI -->
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
$(document).ready(function() {
    // 페이지 로드 시 선택된 학과 정보 복원
    var selectedText = $("#departmentSearch").data("selected-text");
    if (selectedText && $("#departmentId").val()) {
        $("#departmentSearch").val(selectedText);
    }
    // 학교-학과 자동완성
    $("#departmentSearch").autocomplete({
        source: function(request, response) {
            $.ajax({
                url: "/api/departments/search",
                data: { query: request.term },
                success: function(data) {
                    response($.map(data, function(item) {
                        return {
                            label: item.text,
                            value: item.text,
                            id: item.id,
                            schoolName: item.schoolName,
                            departmentName: item.departmentName
                        };
                    }));
                }
            });
        },
        minLength: 2,
        select: function(event, ui) {
            $("#departmentId").val(ui.item.id);
            $("#selectedDepartment").html(
                '<div class="alert alert-info py-2">' +
                '<strong>선택됨:</strong> ' + ui.item.schoolName + ' - ' + ui.item.departmentName +
                '</div>'
            );
        },
        change: function(event, ui) {
            if (!ui.item) {
                $("#departmentId").val("");
                $("#selectedDepartment").empty();
            }
        }
    });
    
    // 이메일 중복 체크
    let emailTimeout;
    $("#email").on("input", function() {
        clearTimeout(emailTimeout);
        const email = $(this).val();
        
        if (email && email.includes("@")) {
            emailTimeout = setTimeout(function() {
                $.ajax({
                    url: "/api/auth/check-email",
                    data: { email: email },
                    success: function(available) {
                        const message = $("#emailCheckMessage");
                        if (available) {
                            message.html('<div class="text-success small">사용 가능한 이메일입니다.</div>');
                        } else {
                            message.html('<div class="text-danger small">이미 사용중인 이메일입니다.</div>');
                        }
                    }
                });
            }, 500);
        }
    });
    
    // 비밀번호 규칙 실시간 검증
    $("#password").on("input", function() {
        const password = $(this).val();
        
        // 길이 체크 (8자 이상)
        if (password.length >= 8) {
            $("#lengthCheck").addClass("valid").find(".requirement-icon").text("✅");
        } else {
            $("#lengthCheck").removeClass("valid").find(".requirement-icon").text("❌");
        }
        
        // 영문 체크
        if (/[A-Za-z]/.test(password)) {
            $("#letterCheck").addClass("valid").find(".requirement-icon").text("✅");
        } else {
            $("#letterCheck").removeClass("valid").find(".requirement-icon").text("❌");
        }
        
        // 숫자 체크
        if (/\d/.test(password)) {
            $("#numberCheck").addClass("valid").find(".requirement-icon").text("✅");
        } else {
            $("#numberCheck").removeClass("valid").find(".requirement-icon").text("❌");
        }
        
        // 특수문자 체크 (@ $ ! % * # ? & _)
        if (/[@$!%*#?&_]/.test(password)) {
            $("#specialCheck").addClass("valid").find(".requirement-icon").text("✅");
        } else {
            $("#specialCheck").removeClass("valid").find(".requirement-icon").text("❌");
        }
        
        // 비밀번호 확인 필드가 있으면 재검증
        if ($("#passwordConfirm").val()) {
            checkPasswordMatch();
        }
    });
    
    // 비밀번호 확인 체크
    function checkPasswordMatch() {
        const password = $("#password").val();
        const passwordConfirm = $("#passwordConfirm").val();
        
        if (passwordConfirm && password !== passwordConfirm) {
            $("#passwordConfirm").addClass("is-invalid");
            if (!$("#passwordConfirm").next(".error-message").length) {
                $("#passwordConfirm").after('<div class="error-message">비밀번호가 일치하지 않습니다.</div>');
            }
        } else {
            $("#passwordConfirm").removeClass("is-invalid");
            $("#passwordConfirm").next(".error-message").remove();
        }
    }
    
    $("#passwordConfirm").on("input", checkPasswordMatch);
    
    // 전화번호 자동 포맷팅
    $("#phoneNumber").on("input", function() {
        let value = $(this).val().replace(/[^0-9]/g, '');
        if (value.length >= 11) {
            value = value.substring(0, 11);
            value = value.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
        } else if (value.length >= 7) {
            value = value.replace(/(\d{3})(\d{3,4})/, '$1-$2');
        }
        $(this).val(value);
    });
});
</script>

</body>
</html>